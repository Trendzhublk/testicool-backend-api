name: CI/CD Deploy

on:
  push:
    branches: ["master"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Set up PHP 8.3
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          tools: composer

      # Install Composer dependencies (no dev)
      - name: Install Composer dependencies (no dev)
        run: composer install --no-progress --prefer-dist --no-dev -o --no-interaction

      # Setup Node
      - name: Set up Node
        if: ${{ hashFiles('package.json') != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      # Build frontend
      - name: Build frontend
        if: ${{ hashFiles('package.json') != '' }}
        run: |
          npm ci
          npm run build

      # Reinstall vendor for production (ensures clean prod deps)
      - name: Reinstall vendor for production
        run: |
          rm -rf vendor
          composer install --no-dev --optimize-autoloader --no-interaction

      # Upload to EC2 using rsync (DEPLOY STRAIGHT TO CURRENT)
      - name: Upload to EC2 (rsync)
        uses: Burnett01/rsync-deployments@7.0.2
        with:
          switches: -avz --delete --omit-dir-times --no-perms --exclude ".env" --exclude "storage"
          path: .
          remote_path: /var/www/myapp/current
          remote_host: 13.62.175.201
          remote_user: deploy
          remote_port: 22
          remote_key: ${{ secrets.DEPLOY_PRIVATE_KEY }}

      # Run commands on EC2
      - name: Run remote deployment commands
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: 13.62.175.201
          username: deploy
          key: ${{ secrets.DEPLOY_PRIVATE_KEY }}
          port: 22
          script: |
            set -e

            CURRENT_DIR="/var/www/myapp/current"
            SHARED_DIR="/var/www/myapp/shared"

            echo "Deploying to: $CURRENT_DIR"
            cd $CURRENT_DIR

            # Ensure shared folder exists (do not delete it)
            mkdir -p $SHARED_DIR/storage

            # Link shared .env and storage into current
            ln -nfs $SHARED_DIR/.env $CURRENT_DIR/.env
            rm -rf $CURRENT_DIR/storage
            ln -nfs $SHARED_DIR/storage $CURRENT_DIR/storage

            # Ensure bootstrap/cache exists
            mkdir -p $CURRENT_DIR/bootstrap/cache

            # Permissions: allow Laravel to write logs/cache
            sudo chown -R www-data:www-data $SHARED_DIR/storage
            sudo chmod -R 775 $SHARED_DIR/storage

            sudo chown -R www-data:www-data $CURRENT_DIR/bootstrap/cache
            sudo chmod -R 775 $CURRENT_DIR/bootstrap/cache

            # Laravel tasks
            composer install --no-dev --optimize-autoloader --no-interaction
            php artisan storage:link || true
            php artisan migrate --force || true
            php artisan optimize

            echo "Deployment completed successfully."
