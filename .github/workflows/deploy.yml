name: CI/CD Deploy

on:
  push:
    branches: ["master"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------
      # 1) Checkout Code
      # ------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------
      # 2) Setup PHP & Composer
      # ------------------------------------------
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          tools: composer

      # ------------------------------------------
      # 3) Install Composer (locally for build)
      # ------------------------------------------
      - name: Install Composer dependencies (local only)
        run: |
          composer install --no-progress --prefer-dist --no-dev -o --no-interaction

      # ------------------------------------------
      # 4) Setup Node (if frontend exists)
      # ------------------------------------------
      - name: Set up Node
        if: ${{ hashFiles('package.json') != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      # ------------------------------------------
      # 5) Build Frontend
      # ------------------------------------------
      - name: Build frontend
        if: ${{ hashFiles('package.json') != '' }}
        run: |
          npm ci
          npm run build

      # ------------------------------------------
      # 6) Cleanup vendor locally (we install again on server)
      # ------------------------------------------
      - name: Cleanup vendor for fresh server install
        run: rm -rf vendor

      # ------------------------------------------
      # 7) Upload to EC2 using rsync (FAST + CLEAN)
      # ------------------------------------------
      - name: Upload to EC2 (rsync)
        uses: Burnett01/rsync-deployments@7.0.2
        with:
          switches: >
            -avz
            --omit-dir-times
            --no-perms
            --no-owner
            --no-group
            --exclude ".git"
            --exclude ".github"
            --exclude ".env"
            --exclude "storage"
            --exclude "bootstrap/cache"
            --exclude "vendor"
            --exclude "node_modules"
          path: .
          remote_path: /var/www/myapp/current
          remote_host: 13.62.175.201
          remote_user: deploy
          remote_port: 22
          remote_key: ${{ secrets.DEPLOY_PRIVATE_KEY }}

      # ------------------------------------------
      # 8) Execute commands on EC2
      # ------------------------------------------
      - name: Run remote deployment commands
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: 13.62.175.201
          username: deploy
          key: ${{ secrets.DEPLOY_PRIVATE_KEY }}
          port: 22
          script: |
            set -e

            CURRENT_DIR="/var/www/myapp/current"
            SHARED_DIR="/var/www/myapp/shared"

            echo "ðŸš€ Deploying to: $CURRENT_DIR"

            cd $CURRENT_DIR

            # Ensure shared structure
            mkdir -p $SHARED_DIR/storage

            # Symlink .env & storage (never overwritten)
            ln -nfs $SHARED_DIR/.env $CURRENT_DIR/.env
            rm -rf $CURRENT_DIR/storage
            ln -nfs $SHARED_DIR/storage $CURRENT_DIR/storage

            # Ensure cache directory exists
            mkdir -p $CURRENT_DIR/bootstrap/cache

            # Fix permissions for Laravel runtime dirs
            sudo chown -R www-data:www-data $SHARED_DIR/storage
            sudo chmod -R 775 $SHARED_DIR/storage
            sudo chown -R www-data:www-data $CURRENT_DIR/bootstrap/cache
            sudo chmod -R 775 $CURRENT_DIR/bootstrap/cache

            # Reinstall vendor on EC2
            echo "Installing vendor packages..."
            composer install --no-dev --optimize-autoloader --no-interaction

            # Laravel tasks
            php artisan storage:link || true
            php artisan migrate --force || true
            php artisan optimize

            echo "ðŸŽ‰ Deployment completed successfully."
